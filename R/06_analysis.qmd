---
title: "05_analysis"
format: html
---

# Analysis

## Loading libraries

```{r}
library("ggrepel")
library("dplyr")
library("tidyverse")
```

## Loading finaldata, featuredata and de_results

```{r}
#| message: false
#| warning: false

finaldata   <- read_csv("../data/03_dat_aug.csv.gz")
featuredata <- read_csv("../data/featuredata.csv.gz")
de_results <- read_csv("../data/03_de_results.csv.gz")
```

## Overall gene expression distribution

To get an idea of the distribution of the genes between samples categorized as either inflamed or uninflamed, we make a histogram (see Figure X), which shows that they have a normal distribution around with a mean slightly above 0. However both distributions appear similar, though the count of genes with uninflamed is higher.

```{r distribution_gene_expression_inflamed_uninflamed}
p <- finaldata |> 
  mutate(inflammation_status = factor(inflammation_status,
                                      levels = c("Uninflamed", "Inflamed"))) |>
  ggplot(aes(x = gene_expr, fill = inflammation_status)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 80) +
  labs(
    fill = "Inflammation state",
    title = "Distribution of gene expression in inflamed and uninflamed samples"
  )+
  theme_minimal()
p

ggsave("distribution_gene_expression_inflamed_uninflamed.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## **Expression by anatomic location and inflammation**

We then try to get an idea, if there is a difference in the gene expression pattern across anatomic locations i.e. different parts of the intestinal tract and whether or not the sample was inflamed or not. From this plot it is not clear, so we explore further.

```{r gene_expression_by_anatomic_location_and_inflammation}
loc_counts <- finaldata |>
  dplyr::count(anatomic_location)

p <- finaldata |> 
  ggplot(aes(x = anatomic_location, y = gene_expr, 
             fill = inflammation_status)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.15, outlier.shape = NA,
               position = position_dodge(width = 0.9)) +
  coord_flip() +
  theme_minimal() +
  scale_x_discrete(
    labels = function(x) {
      paste0(x, " (n = ", loc_counts$n[match(x, loc_counts$anatomic_location)], ")")
    }
  ) +
  labs(
    x = "Anatomic location",
    y = "Gene expression",
    fill = "Inflammation state"
  )
p

ggsave("gene_expression_by_anatomic_location_and_inflammation.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Mean gene expression per patient across in inflamed and un-inflamed samples

We now examine the mean gene expression between inflamed and un-inflamed samples on a patient basis, to see if that showcases a difference in gene expression. The mean gene expression is lower for the un-inflamed patients than for the inflamed patients.

```{r mean_gene_expression_per_patient_inflamed_uninflamed}
patient_means <- finaldata |> 
  group_by(patient, inflammation_status) |> 
  summarise(mean_expr = mean(gene_expr, na.rm = TRUE), .groups = "drop")

ggplot(patient_means, aes(x = inflammation_status, y = mean_expr)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.4) +
  geom_jitter(width = 0.15, alpha = 0.6) +
  theme_minimal() +
  labs(x = "Inflammation status", y = "Mean gene expression per patient")
ggsave("mean_gene_expression_per_patient_inflamed_uninflamed.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Identification of significant genes during dependent on inflammation state using a Volcano plot

Creating a volcano plot to see which genes are significantly (p \< 0.05 ) up-regulated in the un-inflamed and inflamed patients. The biologically relevant genes are selected (the ones with a minimum of log2 fold change of 0.25). The blue dots represent the genes that are significantly up-regulated in un-inflamed patients and the red dots represent the genes that are significantly up-regulated in the inflamed patients. They grey dots represent the genes that did not show any significant up-regulation. The genes that are very significantly up-regulated (p \> 10\^-10) are labeled.

As can be seen in the plot, there are more genes that are up-regulated in inflamed patients than in non-inflamed patients. Some of the genes that are strongly up-regulated are associated with the immune system, e.g. LCN2 and IGHG1, suggesting increased immune activation.

```{r volcano_plot_colonic_gene_expression}
lfc_cut <- 0.25   # Minimum |log2FC|
p_cut   <- 0.05   # p-value threshold

#Add gene symbol by matching finaldata$gene_id with featuredata$ID
de_results_annot <- de_results |>
  mutate(
    GENE_SYMBOL = featuredata$GENE_SYMBOL[
      match(gene_id, featuredata$ID)
    ]
  )

#Label only highly significant genes with valid symbols
label_df <- de_results_annot |>
  filter(
    neg_log10_p > 10,
    !is.na(GENE_SYMBOL)
  )

#Prepare plotting data
plot_df <- de_results_annot |>
  filter(!is.na(p_value)) |>
  mutate(
    FDR = p.adjust(p_value, method = "BH"),
    sig_cat = case_when(
      FDR < 0.05 & log2FC >=  lfc_cut ~ "Up in inflamed",
      FDR < 0.05 & log2FC <= -lfc_cut ~ "Up in uninflamed",
      TRUE                            ~ "Non significant"
    ),
    sig_cat = factor(sig_cat,
                     levels = c("Up in inflamed", "Up in uninflamed", "Non significant"))
  )

sig_genes <- plot_df |>
  filter(sig_cat != "Non significant") |>
  dplyr::select(gene_id, GENE_SYMBOL, log2FC, p_value, FDR, sig_cat) |>
  arrange(FDR)

#Split into up in inflamed / up in uninflamed
up_in_inflamed <- sig_genes |>
  filter(sig_cat == "Up in inflamed") |>
  pull(GENE_SYMBOL)

up_in_uninflamed <- sig_genes |>
  filter(sig_cat == "Up in uninflamed") |>
  pull(GENE_SYMBOL)

#Volcano plot
ggplot(plot_df,
       aes(x = log2FC, y = neg_log10_p, colour = sig_cat)) +
  #Points
  geom_point(size = 1.3, alpha = 0.8) +
  #Cutoff lines
  geom_hline(yintercept = -log10(p_cut),
             linetype = "dashed", linewidth = 0.3) +
  geom_vline(xintercept = c(-lfc_cut, lfc_cut),
             linetype = "dashed", linewidth = 0.3) +
  # labels
  geom_text_repel(
    data = label_df,
    aes(label = GENE_SYMBOL),
    size = 3,
    colour = "black",
    max.overlaps = 30,
    box.padding = 0.4,
    point.padding = 0.3,
    segment.size = 0.2,
    show.legend = FALSE
  ) +

  scale_colour_manual(
    values = c(
      "Up in inflamed"   = "#d73027",
      "Up in uninflamed" = "#4575b4",
      "Non significant"               = "grey80"
    ),
    name = NULL
  ) +
  labs(
    title = "Volcano plot of colonic gene expression",
    subtitle = "Inflamed vs uninflamed biopsies (Gut 57:1398–1405)",
    x = "log2 fold change (Inflamed – Uninflamed)",
    y = expression(-log[10](italic(p)~value))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 11),
    axis.title = element_text(size = 12)
  )
ggsave("volcano_plot_colonic_gene_expression.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Expression of the 40 most significant genes

Plotting the expression of the 40 most significant genes in both inflamed and un-inflamed patients. The inflamed patients have a higher expression of some of the genes associated with immune activation compared to the un-inflamed patients. This is for example LCN2 and IGHG1 which is in compliance with the results from the volcano plot. Some of the genes that are down-regulated include GCNT2 and UGT2A3 which are housekeeping genes that are suppressed to free up resources.

```{r top40_differential_genes_across_samples}
#Pick top 40 most significant genes
top_markers <- sig_genes |>
  slice_min(FDR, n = 40) |>
  dplyr::select(gene_id, GENE_SYMBOL)

#Join
heat_df <- finaldata |>
  inner_join(top_markers, by = "gene_id") |>
  filter(!is.na(GENE_SYMBOL)) |>
  distinct(patient, inflammation_status, GENE_SYMBOL, gene_expr) |>
  mutate(patient = factor(patient))     #Make patient discrete

#Reorder symbols by average expression difference
symbol_order <- heat_df |>
  group_by(GENE_SYMBOL) |>
  summarise(mean_expr = mean(gene_expr, na.rm = TRUE)) |>
  arrange(desc(mean_expr)) |>
  pull(GENE_SYMBOL)

heat_df$GENE_SYMBOL <- factor(heat_df$GENE_SYMBOL, levels = symbol_order)

# draw heatmap
ggplot(heat_df,
       aes(x = patient, y = GENE_SYMBOL, fill = gene_expr)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_grid(~ inflammation_status, scales = "free_x", space = "free_x") +
  labs(
    x = "Patient",
    y = "Gene symbol",
    fill = "Expression",
    title = "Top 40 differential genes across samples"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid   = element_blank()
  )
ggsave("top40_differential_genes_across_samples.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Correlation between time untreated and gene expression

Plotting the correlation between the time patients went untreated and the gene expression of significant genes. Looking at the genes that were up-regulated in inflamed patients (red) it can be seen that some of the patients with the genes that were the most up-regulated went to the doctor earlier compared to some of the patients that had genes that were the least up-regulated.

```{r correlation_time_untreated_significant_genes}
finaldata |>
  filter(gene_id == sig_genes$gene_id) |> 
  select(geo_accession, gene_id, time_untreated, disease, family_history) |> 
  left_join(sig_genes, finaldata, by = "gene_id") |> 
  group_by(GENE_SYMBOL) %>% filter(n() >= 2) |> 
  filter(time_untreated > 0) |> 
  ggplot(aes(x = time_untreated, y = log2FC, 
             color = sig_cat)) +
  geom_point(alpha = 0.5) +
  theme_minimal() +
  labs(title = "Correlation between time untreated and expression of significant genes", x = "Time untreated (days)", y = "log2FC", color = "Inflammation status") + 
  theme(legend.position = "bottom")
ggsave("correlation_time_untreated_significant_genes.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Cleaning environment

```{r}
rm(list = ls())
```
