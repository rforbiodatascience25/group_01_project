---
title: "07_analysis"
format: html
---

```{r}
#| message: false
#| warning: false

finaldata <- read_csv("../data/03_dat_aug.csv.gz")
featuredata <- read_csv("../data/featuredata.csv.gz")
source("99_proj_func.R")

colnames(finaldata)
colnames(featuredata)
```

### Smoking

```{r}
finaldata |>  
  filter(!is.na(smoking_status)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(smoking_status) |> 
  summarise(n = n()) 

finaldata |>  
  filter(!is.na(smoking_status)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(smoking_status) |> 
  ggplot(aes(x = smoking_status, y = time_untreated)) +
    geom_boxplot() + 
    theme_minimal() + 
    labs(x = "Smoking Status",
         y = "Time to diagnostics (days)",
         title = "Time from 1st UC symtomps to diagnostics against smoking") +
    theme(
      plot.title = element_text(size = 12)   # << decrease title size
    )
```

#### Age

```{r}
finaldata |>  
  filter(!is.na(age_group)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(age_group) |> 
  summarise(n = n())

finaldata |>  
  filter(!is.na(age_group)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(age_group) |> 
  ggplot(aes(x = age_group, y = time_untreated)) +
    geom_boxplot() + 
    theme_minimal() + 
    labs(x = "Age Groups",
         y = "Time to diagnostics (days)",
         title = "Time from 1st UC symtomps to diagnostics against age") +
    theme(
      plot.title = element_text(size = 12)   # << decrease title size
    )
```

# GC and AT content

```{r}
gc_content <- function(seq) {
  seq <- toupper(seq)
  chars <- strsplit(seq, "")[[1]]
  g <- sum(chars == "G")
  c <- sum(chars == "C")
  return((g + c) / length(chars))
}

featuredata$GC_content <- sapply(featuredata$SEQUENCE, gc_content)


names(featuredata)[names(featuredata) == "ID"] <- "gene_id"
merged <- merge(featuredata, finaldata, by = "gene_id")

boxplot(GC_content ~ disease,
        data = merged,
        col = c("lightblue", "lightpink"),
        xlab = "Condition (disease)",
        ylab = "GC-content",
        main = "GC-content comparison between healthy and diseased subjects")

```

There is no significant difference in the amount of G and C in the sequences between the two groups of Patients and Controls

```{r}
at_content <- function(seq) {
  seq <- toupper(seq)
  chars <- strsplit(seq, "")[[1]]
  a <- sum(chars == "A")
  t <- sum(chars == "T")
  return((a + t) / length(chars))
}

featuredata$at_content <- sapply(featuredata$SEQUENCE, at_content)


names(featuredata)[names(featuredata) == "ID"] <- "gene_id"
merged <- merge(featuredata, finaldata, by = "gene_id")

boxplot(at_content ~ disease,
        data = merged,
        col = c("lightblue", "lightpink"),
        xlab = "Condition (disease)",
        ylab = "AT-content",
        main = "AT-content comparison between healthy and diseased subjects")

```

There is no significant difference in the amount of A and T in the sequences between the two groups of Patients and Controls

# Significance based on anatomical location

```{r}
library(dplyr)
library(ggplot2)

de_by_loc <- finaldata |>
  filter(complete.cases(gene_expr, inflammation_status, anatomic_location)) |>
  mutate(inflammation_status = factor(inflammation_status, c("Uninflamed","Inflamed"))) |>
  group_by(anatomic_location, gene_id) |>
  summarise(
    log2FC  = mean(gene_expr[inflammation_status=="Inflamed"]) -
              mean(gene_expr[inflammation_status=="Uninflamed"]),
    p_value = t_safe(gene_expr, inflammation_status),
    .groups = "drop"
  ) |>
  group_by(anatomic_location) |>
  mutate(FDR = p.adjust(p_value, "BH"), sig = !is.na(FDR) & FDR < .05) |>
  ungroup()

de_by_loc |>
  group_by(anatomic_location, sig) |>
  summarise(n = n(), .groups = "drop") |>
  ggplot(aes(anatomic_location, n, fill = sig)) +
  geom_col(position = "dodge") +
  coord_flip() +
  theme_minimal()
```

The graph shows that significant variations in expression between inflamed and non-inflamed samples appear only in the descending colon and sigmoid colon. In the ascending colon, the differences do not exceed the significance threshold, while in the terminal ileum, the inflamed samples are too few to make a reliable comparison.

## Cleaning environment

```{r}
rm(list = ls())
```
