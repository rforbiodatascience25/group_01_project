---
title: "07_analysis"
format: html
---

# Analysis 3

```{r}
#| message: false
#| warning: false

finaldata <- read_csv("../data/03_dat_aug.csv.gz")
featuredata <- read_csv("../data/featuredata.csv.gz")
source("99_proj_func.R")

library(dplyr)
library(ggplot2)

colnames(finaldata)
colnames(featuredata)
```

### Smoking

```{r time_to_diagnosis_vs_smoking_status}
finaldata |>  
  filter(!is.na(smoking_status)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(smoking_status) |> 
  summarise(n = n()) 

finaldata |>  
  filter(!is.na(smoking_status)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(smoking_status) |> 
  ggplot(aes(x = smoking_status, y = time_untreated)) +
    geom_boxplot() + 
    theme_minimal() + 
    labs(x = "Smoking Status",
         y = "Time to diagnostics (days)",
         title = "Time from 1st UC symtomps to diagnostics against smoking") +
    theme(
      plot.title = element_text(size = 12)
    )
```

#### Age

```{r time_to_diagnosis_vs_age}
finaldata |>  
  filter(!is.na(age_group)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(age_group) |> 
  summarise(n = n())

finaldata |>  
  filter(!is.na(age_group)) |> 
  filter(!is.na(time_untreated)) |> 
  filter(time_untreated > 0) |> 
  group_by(age_group) |> 
  ggplot(aes(x = age_group, y = time_untreated)) +
    geom_boxplot() + 
    theme_minimal() + 
    labs(x = "Age Groups",
         y = "Time to diagnostics (days)",
         title = "Time from 1st UC symtomps to diagnostics against age") +
    theme(
      plot.title = element_text(size = 12)
    )
```

## GC and AT content

```{r gc_content_comparison_healthy_vs_diseased}
gc_content <- function(seq) {
  seq <- toupper(seq)
  chars <- strsplit(seq, "")[[1]]
  g <- sum(chars == "G")
  c <- sum(chars == "C")
  return((g + c) / length(chars))
}

featuredata$GC_content <- sapply(featuredata$SEQUENCE, gc_content)


names(featuredata)[names(featuredata) == "ID"] <- "gene_id"
merged <- merge(featuredata, finaldata, by = "gene_id")

boxplot(GC_content ~ disease,
        data = merged,
        col = c("lightblue", "lightpink"),
        xlab = "Condition (disease)",
        ylab = "GC-content",
        main = "GC-content comparison between healthy and diseased subjects")

```

There is no significant difference in the amount of G and C in the sequences between the two groups of Patients and Controls

```{r at_content_comparison_healthy_vs_diseased}
at_content <- function(seq) {
  seq <- toupper(seq)
  chars <- strsplit(seq, "")[[1]]
  a <- sum(chars == "A")
  t <- sum(chars == "T")
  return((a + t) / length(chars))
}

featuredata$at_content <- sapply(featuredata$SEQUENCE, at_content)


names(featuredata)[names(featuredata) == "ID"] <- "gene_id"
merged <- merge(featuredata, finaldata, by = "gene_id")

boxplot(at_content ~ disease,
        data = merged,
        col = c("lightblue", "lightpink"),
        xlab = "Condition (disease)",
        ylab = "AT-content",
        main = "AT-content comparison between healthy and diseased subjects")

```

There is no significant difference in the amount of A and T in the sequences between the two groups of Patients and Controls

## Significance based on anatomical location

```{r significant_gene_counts_by_anatomic_location}
de_by_loc <- finaldata |>
  filter(complete.cases(gene_expr, inflammation_status, anatomic_location)) |>
  mutate(inflammation_status = factor(inflammation_status,
                                      c("Uninflamed", "Inflamed"))) |>
  group_by(anatomic_location, gene_id) |>
  #Keep only genes where both groups are present in that location
  filter(n_distinct(inflammation_status) == 2) |>
  summarise(
    log2FC  = mean(gene_expr[inflammation_status == "Inflamed"],   na.rm = TRUE) -
              mean(gene_expr[inflammation_status == "Uninflamed"], na.rm = TRUE),

    p_value = tryCatch(
      t.test(gene_expr ~ inflammation_status)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) |>
  group_by(anatomic_location) |>
  mutate(
    FDR = p.adjust(p_value, "BH"),
    sig = !is.na(FDR) & FDR < 0.05
  ) |>
  ungroup()

de_by_loc |>
  group_by(anatomic_location, sig) |>
  summarise(n = n(), .groups = "drop") |>
  ggplot(aes(anatomic_location, n, fill = sig)) +
  geom_col(position = "dodge") +
  coord_flip() +
  theme_minimal()
```

The graph shows that significant variations in expression between inflamed and non-inflamed samples appear only in the descending colon and sigmoid colon. In the ascending colon, the differences do not exceed the significance threshold, while in the terminal ileum, the inflamed samples are too few to make a reliable comparison.

## Cleaning environment

```{r}
rm(list = ls())
```
