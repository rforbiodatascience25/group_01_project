---
title: "05_analysis_1"
format: html
---

```{r}
ggplot(finaldata, aes(x = `inflammation_status:ch1`, y = gene_expr)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, alpha = 0.4) +
  theme_minimal() +
  labs(
    x = "Inflammation status",
    y = "Gene expression"
  )
```

```{r}
finaldata_clean <- finaldata |> 
  filter(is.finite(gene_expr))

k_out <- kmeans(finaldata_clean$gene_expr, centers = 2)

finaldata_k <- finaldata_clean |> 
  mutate(cluster = factor(k_out$cluster))
```

```{r}
ggplot(finaldata_k,
       aes(x = cluster, y = gene_expr, colour = `inflammation_status:ch1`)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.4) +
  geom_jitter(width = 0.1, alpha = 0.6) +
  theme_minimal() +
  labs(
    x = "k-means cluster",
    y = "Gene expression",
    colour = "Inflammation status"
  )
```

```{r}
expr_mat <- finaldata |> 
  select(sample_id = geo_accession, gene_id, gene_expr) |> 
  pivot_wider(
    names_from  = gene_id,
    values_from = gene_expr
  )
```

```{r}
# Extract gene matrix
gene_mat <- expr_mat |> 
  select(-sample_id) |> 
  as.matrix()

# Drop genes with NA or zero variance
keep_cols <- apply(gene_mat, 2, function(x) all(is.finite(x)) && var(x) > 0)
gene_mat_clean <- gene_mat[, keep_cols]

# Scale genes
gene_mat_scaled <- scale(gene_mat_clean)

# PCA on samples
pca <- prcomp(gene_mat_scaled)

# k-means on first 10 PCs (you can change)
set.seed(1)
k_out <- kmeans(pca$x[, 1:10], centers = 2)
```

```{r}
sample_meta <- finaldata |> 
  select(sample_id = geo_accession,
         inflammation_status = `inflammation_status:ch1`) |> 
  distinct()
```

```{r}
plot_df <- data.frame(
  sample_id = expr_mat$sample_id,
  PC1 = pca$x[,1],
  PC2 = pca$x[,2],
  cluster = factor(k_out$cluster)
) |> 
  left_join(sample_meta, by = "sample_id")
```

```{r}
ggplot(plot_df, aes(PC1, PC2)) +
  geom_point(aes(color = cluster, shape = inflammation_status), size = 1) +
  theme_minimal() +
  labs(
    x = "PC1",
    y = "PC2",
    color = "k-means cluster",
    shape = "Inflammation status"
  )
```
