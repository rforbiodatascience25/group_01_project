---
title: "05_analysis_1"
format: html
---

# Analysis

## Init

```{r}
library(ggrepel)
```

# Load

```{r}
finaldata   <- read_csv("../data/finaldata.csv.gz")
featuredata <- read_csv("../data/featuredata.csv.gz")
```

## Overall gene expression distribution

To get an idea of the distribution of the genes between samples categorized as either inflamed or uninflamed, we make a histogram (see Figure X), which shows that they have a normal distribution around 0.

```{r}
finaldata |> 
  mutate(inflammation_status = factor(inflammation_status,
                                      levels = c("Uninflamed", "Inflamed"))) |>
  ggplot(aes(x = gene_expr, fill = inflammation_status)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 80) +
  labs(
    fill = "Inflammation state",
    title = "Distribution of gene expression in inflamed and uninflamed samples"
  )+
  theme_minimal()
```

## **Expression by anatomic location and inflammation**

We then try to get an idea, if there is a difference in the gene expression pattern across anatomic locations and whether or not the sample experienced inflammation or not. From this plot it is not clear so we explore further.

```{r}
loc_counts <- finaldata |>
  count(anatomic_location)

finaldata |> 
  ggplot(aes(x = anatomic_location, y = gene_expr, 
             fill = inflammation_status)) +
  geom_violin(trim = FALSE, alpha = 0.5) +
  geom_boxplot(width = 0.15, outlier.shape = NA,
               position = position_dodge(width = 0.9)) +
  coord_flip() +
  theme_minimal() +
  scale_x_discrete(
    labels = function(x) {
      paste0(x, " (n = ", loc_counts$n[match(x, loc_counts$anatomic_location)], ")")
    }
  ) +
  labs(
    x = "Anatomic location",
    y = "Gene expression",
    fill = "Inflammation state"
  )
```

## Mean gene expression per patient across in inflamed and uninflamed samples

We now examine the mean gene expression between inflamed and uninflamed samples on a patient basis, to see if that showcases a difference in gene expression.

```{r}
patient_means <- finaldata |> 
  group_by(patient, inflammation_status) |> 
  summarise(mean_expr = mean(gene_expr, na.rm = TRUE), .groups = "drop")

ggplot(patient_means, aes(x = inflammation_status, y = mean_expr)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.4) +
  geom_jitter(width = 0.15, alpha = 0.6) +
  theme_minimal() +
  labs(x = "Inflammation status", y = "Mean gene expression per patient")
```

## Identification of significant genes during dependent on inflammation state using a Volcano plot

### Consider Moving to 03_augment

```{r}
final_clean <- finaldata |>
  filter(!is.na(gene_expr),
         !is.na(inflammation_status)) |>
  mutate(
    inflammation_status = factor(inflammation_status,
                                 levels = c("Uninflamed", "Inflamed")) # control first
  )
```

```{r}
de_results <- final_clean |>
  group_by(gene_id) |>
  # keep only genes that have both groups present
  filter(n_distinct(inflammation_status) == 2) |>
  summarise(
    mean_inflamed   = mean(gene_expr[inflammation_status == "Inflamed"],   na.rm = TRUE),
    mean_uninflamed = mean(gene_expr[inflammation_status == "Uninflamed"], na.rm = TRUE),

    # already log2 → fold change is just the difference
    log2FC = mean_inflamed - mean_uninflamed,

    p_value = tryCatch(
      t.test(gene_expr ~ inflammation_status)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) |>
  mutate(
    neg_log10_p = -log10(p_value),
    sig = p_value < 0.05   # or adjust later with p.adjust()
  )
```

### --- To here

```{r}
lfc_cut <- 0.25   # minimum |log2FC| to call biologically relevant
p_cut   <- 0.05   # p-value threshold for the dashed line

## 1) Add gene symbol by matching finaldata$gene_id --> featuredata$ID
de_results_annot <- de_results |>
  mutate(
    GENE_SYMBOL = featuredata$GENE_SYMBOL[
      match(gene_id, featuredata$ID)  # <-- your working mapping
    ]
  )

## 2) Label only highly significant genes with valid symbols
label_df <- de_results_annot |>
  filter(
    neg_log10_p > 10,          # very strong p-values
    !is.na(GENE_SYMBOL)
  )

## 3) Prepare plotting data: FDR + 3-level significance category
plot_df <- de_results_annot |>
  filter(!is.na(p_value)) |>
  mutate(
    FDR = p.adjust(p_value, method = "BH"),
    sig_cat = case_when(
      FDR < 0.05 & log2FC >=  lfc_cut ~ "Up in inflamed",
      FDR < 0.05 & log2FC <= -lfc_cut ~ "Up in uninflamed",
      TRUE                            ~ "Non significant"
    ),
    sig_cat = factor(sig_cat,
                     levels = c("Up in inflamed", "Up in uninflamed", "Non significant"))
  )

sig_genes <- plot_df |>
  filter(sig_cat != "Non significant") |>
  dplyr::select(gene_id, GENE_SYMBOL, log2FC, p_value, FDR, sig_cat) |>
  arrange(FDR)

# split into up in inflamed / up in uninflamed
up_in_inflamed <- sig_genes |>
  filter(sig_cat == "Up in inflamed") |>
  pull(GENE_SYMBOL)

up_in_uninflamed <- sig_genes |>
  filter(sig_cat == "Up in uninflamed") |>
  pull(GENE_SYMBOL)

## 4) Volcano plot
ggplot(plot_df,
       aes(x = log2FC, y = neg_log10_p, colour = sig_cat)) +
  # points
  geom_point(size = 1.3, alpha = 0.8) +
  # cutoff lines
  geom_hline(yintercept = -log10(p_cut),
             linetype = "dashed", linewidth = 0.3) +
  geom_vline(xintercept = c(-lfc_cut, lfc_cut),
             linetype = "dashed", linewidth = 0.3) +
  # labels for strongest hits
  geom_text_repel(
    data = label_df,
    aes(label = GENE_SYMBOL),
    size = 3,
    colour = "black",
    max.overlaps = 30,
    box.padding = 0.4,
    point.padding = 0.3,
    segment.size = 0.2,
    show.legend = FALSE
  ) +
  # nicer colours
  scale_colour_manual(
    values = c(
      "Up in inflamed"   = "#d73027",
      "Up in uninflamed" = "#4575b4",
      "Non significant"               = "grey80"
    ),
    name = NULL
  ) +
  labs(
    title = "Volcano plot of colonic gene expression",
    subtitle = "Inflamed vs uninflamed biopsies (Gut 57:1398–1405)",
    x = "log2 fold change (Inflamed – Uninflamed)",
    y = expression(-log[10](italic(p)~value))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 11),
    axis.title = element_text(size = 12)
  )
```

```{r}

# pick e.g. top 40 most significant genes
top_markers <- sig_genes |>
  slice_min(FDR, n = 40) |>
  dplyr::select(gene_id, GENE_SYMBOL)          # keep both id + symbol

# join symbols onto finaldata
# pick e.g. top 40 most significant genes
top_markers <- sig_genes |>
  slice_min(FDR, n = 40) |>
  dplyr::select(gene_id, GENE_SYMBOL)          # keep both id + symbol

# join symbols onto finaldata
heat_df <- finaldata |>
  inner_join(top_markers, by = "gene_id") |>
  filter(!is.na(GENE_SYMBOL)) |>          # drop genes without symbol if you like
  distinct(patient, inflammation_status, GENE_SYMBOL, gene_expr) |>
  mutate(patient = factor(patient))       # <- make patient discrete

# reorder symbols by average expression difference → nicer heatmap ordering
symbol_order <- heat_df |>
  group_by(GENE_SYMBOL) |>
  summarise(mean_expr = mean(gene_expr, na.rm = TRUE)) |>
  arrange(desc(mean_expr)) |>
  pull(GENE_SYMBOL)

heat_df$GENE_SYMBOL <- factor(heat_df$GENE_SYMBOL, levels = symbol_order)

# draw heatmap
ggplot(heat_df,
       aes(x = patient, y = GENE_SYMBOL, fill = gene_expr)) +
  geom_tile() +
  scale_fill_viridis_c() +
  facet_grid(~ inflammation_status, scales = "free_x", space = "free_x") +
  labs(
    x = "Patient",
    y = "Gene symbol",
    fill = "Expression",
    title = "Top 40 differential genes across samples"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid   = element_blank()
  )
```

# Cleaning environment

```{r}
rm(list = ls())
```
