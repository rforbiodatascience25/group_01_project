---
title: "08_analysis_umap"
format: html
---

# Analysis 4

## Loading libraries

```{r}
#| message: false
#| warning: false

library(tidyverse)
library(randomForest)
set.seed(6969) #Setting seed for reproducability
```

```{r}
#| message: false
#| warning: false

expr_df <- read_csv("../data/03_rf_expr_df.csv.gz") #used for input nodes
featuredata <- read_csv("../data/03_dat_genbank.csv.gz") #used for classifier target
de_results <- read_csv("../data/03_de_results.csv.gz") #required for vulcano plot
```

## Model Training

### Splitting dataset into train and test

We start by splitting the data into train and test data sets. The model is allowed to "learn" correlations on train, and it's performance can then be evaluated using test_data.

```{r}
percent_train <- 0.8 #use 80% of the data for train 
train_index <- sample(1:nrow(expr_df), 0.8 * nrow(expr_df))

train_data <- expr_df[train_index, ]
test_data <- expr_df[-train_index, ]
```

Its important that the model never "sees" the test data, as we need the model performance metrics to be truly independent. This reduces the chance of the model fitting to correlations specific to the data values, rather than a biological signal.

### Running the RF Classifier model

The target value "y_pred_UC" for the model is whether the sample was from an individual with (1) or without (0) UC. This column is prepared previously in 03_augment.qmd.

```{r}
#y_pred_UC as factor was not implemented in 03_augment, despite the use of as.factor()
train_data <- train_data |> 
  mutate(y_pred_UC = as.factor(y_pred_UC))
```

Each gene is its own input node for the model.

```{r}
# y_pred_UC ~ . 
train_data.rf <- randomForest(y_pred_UC ~ . - geo_accession, 
                              type = "classification",
                              data = train_data, 
                              mtry = 3,
                              importance = TRUE)

# importance = True is used to obtain most contributing inputs; aka genes
```

## Model Evaluation

### Deriving the Confusion Matrix of the RF model

```{r}
test_pred <- predict(train_data.rf, test_data)
confusion_matrix <- table(Predicted = test_pred, Actual = test_data$y_pred_UC)
print(confusion_matrix)
```

Confusion matrix shows the amount of times the model predicted 0 or 1 (rows), based on the actual values of 0 or 1 in the test dataset. It therefore shows:

|     |     |
|:---:|:---:|
| TN  | FN  |
| FP  | TP  |

where;

-   TN: True Negative

-   FN: False Negative

-   FP: False Positive

-   TP: True Positive

From the matrix, we can obtain an accuracy score.

```{r}
#Correct predictions; TN, TP
TN <- confusion_matrix[1, 1]
TP <- confusion_matrix[2, 2]
FP <- confusion_matrix[2, 1]
FN <- confusion_matrix[1, 2]

total <- sum(confusion_matrix)
acc <- (TN+TP)/total
print(acc)
```

The model emitted a 78% accuracy.

### Importance measure of Genes

We would like to find the model contributing genes in the model, to see which genes (at least in the eyes of the model), speaks to samples with and without UC.

```{r}
var_importance <- as.data.frame(round(importance(train_data.rf), 2))
```

```{r}
var_importance <- var_importance |> 
  mutate(gene_id = str_split_i(rownames(var_importance), "_", 2))
```

```{r}
var_importance |> 
  #mutate(gene_id = str_split_i(rownames(var_importance), "_", 2)) |> 
  arrange(desc(MeanDecreaseAccuracy)) |> 
  slice(1:15) |>
  ggplot(aes(
    # Use reorder() to automatically sort the bars by the MeanDecreaseAccuracy value
    x = reorder(gene_id, MeanDecreaseAccuracy), 
    y = MeanDecreaseAccuracy
  )) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() + 
  labs(
    title = "Top 15 Most Contributing Genes in RF",
    x = "Gene",
    y = "Mean decrease accuracy from RF"
  ) +
  theme_minimal()
ggsave("top15_most_contributing_genes_RF.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

Extract gene_ids as list

```{r}
most_contributing_vars <- var_importance |> 
  arrange(desc(MeanDecreaseAccuracy)) |> 
  slice(1:15) |> 
  rownames()
```

### Match gene_id with gene_symbol to match other analysis

GENE_SYMBOL can be found in featuredata. This is used to map to the results of the vulcano plot.

```{r}
#Splitting gene_id into only the number and converting to numeric
most_contributing_vars <- most_contributing_vars |> 
  str_split_i("_", 2) |> 
  parse_number()

most_contributing_vars <- as.data.frame(most_contributing_vars)
most_contributing_vars <- most_contributing_vars |> 
  mutate(ID = most_contributing_vars) |> 
  select(ID)
```

```{r}
most_contributing_gene_symbols <- featuredata |>
  select(ID, GENE_SYMBOL) |> 
  right_join(most_contributing_vars, featuredata, by="ID") |> 
  select(GENE_SYMBOL) |>
  filter(!is.na(GENE_SYMBOL)) |> 
  pull(GENE_SYMBOL)

print(most_contributing_gene_symbols)
```

## Comparison of identified genes impacting inflammation with disease state

To visualize overlay between significant genes found in 05_analysis, and the RandomForest model most contributing variables.

The 05_analysis relied on inflammation status, and the model relied on disease state.

```{r}
#| warning: false
#| message: false
de_results <- read_csv("../data/03_de_results.csv.gz")
```

```{r}
lfc_cut <- 0.25   # minimum |log2FC| to call biologically relevant
p_cut   <- 0.05   # p-value threshold for the dashed line

# Add gene symbol by matching finaldata$gene_id --> featuredata$ID
de_results_annot <- de_results |>
  mutate(
    GENE_SYMBOL = featuredata$GENE_SYMBOL[
      match(gene_id, featuredata$ID)
    ]
  )

# Label only highly significant genes with valid symbols
label_df <- de_results_annot |>
  filter(
    neg_log10_p > 10,         
    !is.na(GENE_SYMBOL)
  )

# Prepare plotting data: FDR + 3-level significance category
plot_df <- de_results_annot |>
  filter(!is.na(p_value)) |>
  mutate(
    FDR = p.adjust(p_value, method = "BH"),
    sig_cat = case_when(
      FDR < 0.05 & log2FC >=  lfc_cut ~ "Up in inflamed",
      FDR < 0.05 & log2FC <= -lfc_cut ~ "Up in uninflamed",
      TRUE                           ~ "Non significant"
    ),
    sig_cat = factor(sig_cat,
                     levels = c("Up in inflamed", "Up in uninflamed", "Non significant")),
    
    # Identify genes from the highlight list
    highlight_cat = case_when(
      GENE_SYMBOL %in% most_contributing_gene_symbols ~ "Most Contributing",
      TRUE ~ "Other"
    )
  )

sig_genes <- plot_df |>
  filter(sig_cat != "Non significant") |>
  dplyr::select(gene_id, GENE_SYMBOL, log2FC, p_value, FDR, sig_cat) |>
  arrange(FDR)

# split into up in inflamed / up in uninflamed
up_in_inflamed <- sig_genes |>
  filter(sig_cat == "Up in inflamed") |>
  pull(GENE_SYMBOL)

up_in_uninflamed <- sig_genes |>
  filter(sig_cat == "Up in uninflamed") |>
  pull(GENE_SYMBOL)

# Volcano plot with Highlighted Genes
ggplot(plot_df,
       aes(x = log2FC, y = neg_log10_p)) +

  # 1. Base points (coloured by sig_cat)
  geom_point(aes(color = sig_cat), size = 1.3, alpha = 0.8) +

  # 2. Overlay highlighted genes (colored by highlight_cat)
  geom_point(data = filter(plot_df, highlight_cat == "Most Contributing"),
             aes(color = highlight_cat),
             size = 1.3) +

  # cutoff lines
  geom_hline(yintercept = -log10(p_cut),
             linetype = "dashed", linewidth = 0.3) +
  geom_vline(xintercept = c(-lfc_cut, lfc_cut),
             linetype = "dashed", linewidth = 0.3) +

  # labels for strongest hits
  geom_text_repel(
    data = label_df,
    aes(label = GENE_SYMBOL),
    size = 3,
    colour = "black",
    max.overlaps = 30,
    box.padding = 0.4,
    point.padding = 0.3,
    segment.size = 0.2,
    show.legend = FALSE
  ) +

  # unified color scale (sig categories + highlighted category)
  scale_color_manual(
    values = c(
      "Up in inflamed"   = "#d73027",
      "Up in uninflamed" = "#4575b4",
      "Non significant"  = "grey80",
      "Most Contributing" = "green"
    ),
    name = NULL,
    labels = c(
      "Up in inflamed"   = "Up in inflamed",
      "Up in uninflamed" = "Up in uninflamed",
      "Non significant"  = "Non significant",
      "Most Contributing" = "Genes affecting UC diagnosis present in RF model"
    )
  ) +

  labs(
    title = "Volcano plot of colonic gene expression",
    subtitle = "Inflamed vs uninflamed biopsies (Gut 57:1398–1405)",
    x = "log2 fold change (Inflamed – Uninflamed)",
    y = expression(-log[10](italic(p)~value))
  ) +
  theme_minimal(base_size = 10) +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 11),
    axis.title = element_text(size = 12)
  )
ggsave("volcano_plot_colonic_gene_expression_RF.png", path = "../results", dpi = 300, width = 20, height = 12, units = "cm")
```

## Cleaning environment

```{r}
rm(list = ls())
```
