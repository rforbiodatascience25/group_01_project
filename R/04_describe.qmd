---
title: "04_describe"
format: html
---

```{r}
library(dplyr)
library(table1)
```

# Finaldata:

```{r}
# Prima della conversione
table(finaldata$calprotectin, useNA = "ifany")
```

```{r}
fin_all <- finaldata |>
  select(
    patient,
    ethnicity,
    joint_problems,
    uc_flare_up,
    family_history,
    aza_treated,
    aza_tolerant,
    aza_at_present,
    ucss,
    calprotectin,
    esr,
    crp,
    hb,
    wcc,
    neutrophils,
    albumin,
    ibd_affected_relatives,
    smoking_status,
    smoking_amount,
    other_illnesses,
    disease,
    anatomic_location,
    inflammation_status,
    category
  ) |>
  distinct(patient, .keep_all = TRUE) |>
  mutate(
    ucss = suppressWarnings(as.numeric(ucss)),
    calprotectin = suppressWarnings(as.numeric(calprotectin)),
    esr = suppressWarnings(as.numeric(esr)),
    crp = suppressWarnings(as.numeric(crp)),
    hb = suppressWarnings(as.numeric(hb)),
    wcc = suppressWarnings(as.numeric(wcc)),
    neutrophils = suppressWarnings(as.numeric(neutrophils)),
    albumin = suppressWarnings(as.numeric(albumin)),
    smoking_amount = suppressWarnings(as.numeric(smoking_amount)),
    ethnicity = factor(ethnicity),
    joint_problems = factor(joint_problems),
    uc_flare_up = factor(uc_flare_up),
    family_history = factor(family_history),
    aza_treated = factor(aza_treated),
    aza_tolerant = factor(aza_tolerant),
    aza_at_present = factor(aza_at_present),
    ibd_affected_relatives = factor(ibd_affected_relatives),
    smoking_status = factor(smoking_status),
    disease = factor(disease),
    anatomic_location = factor(anatomic_location),
    inflammation_status = factor(inflammation_status),
    category = factor(category)
  )

```

```{r}
fin_all$hb[fin_all$hb == 0]<- NA
fin_all$wcc[fin_all$wcc == 0]<- NA
fin_all$neutrophils[fin_all$neutrophils == 0]<- NA
fin_all$albumin[fin_all$albumin == 0]<- NA
```

```{r}
fin_all$other_illnesses_clean <- dplyr::case_when(
  is.na(fin_all$other_illnesses) ~ NA_character_,
  fin_all$other_illnesses %in% c("none", "None", "NONE") ~ "None",
  TRUE ~ "Any comorbidity"
)

fin_all$other_illnesses_clean <- factor(
  fin_all$other_illnesses_clean,
  levels = c("None", "Any comorbidity")
)

```

```{r}
label(fin_all$ucss) <- "UC symptom score"
label(fin_all$calprotectin) <- "Calprotectin"
label(fin_all$esr) <- "ESR"
label(fin_all$crp) <- "CRP"
label(fin_all$hb) <- "Hemoglobin"
label(fin_all$wcc) <- "White cell count"
label(fin_all$neutrophils) <- "Neutrophils"
label(fin_all$albumin) <- "Albumin"

label(fin_all$ethnicity) <- "Ethnicity"
label(fin_all$joint_problems) <- "Joint problems"
label(fin_all$uc_flare_up) <- "UC flare-up"
label(fin_all$family_history) <- "Family history of IBD"
label(fin_all$aza_treated) <- "Azathioprine treated"
label(fin_all$aza_tolerant) <- "Azathioprine tolerant"
label(fin_all$aza_at_present) <- "Azathioprine at present"
label(fin_all$ibd_affected_relatives) <- "IBD-affected relatives"
label(fin_all$smoking_status) <- "Smoking status"
label(fin_all$other_illnesses_clean) <- "Other illnesses"
label(fin_all$disease) <- "Disease group"
label(fin_all$anatomic_location) <- "Anatomic location"
label(fin_all$inflammation_status) <- "Inflammation status"
label(fin_all$category) <- "Category"

```

```{r}
table1(
  ~ ucss + calprotectin + esr + crp +
    hb + wcc + neutrophils + albumin +
    ethnicity + smoking_status + other_illnesses_clean +
    anatomic_location + inflammation_status + category
  | disease,
  data = fin_all
)
```

```{r}
# Dopo la conversione
table(fin_all$calprotectin, useNA = "ifany")
```

```{r}
fin_all |>
  group_by(disease) |>
  summarise(
    n = n(),
    n_nonNA = sum(!is.na(calprotectin)),
    n_NA = sum(is.na(calprotectin))
  )
```

Nel complesso sono stati inclusi 93 campioni, di cui 63 (67,7%) provenienti da pazienti con colite ulcerosa (UC) e 30 (32,3%) da soggetti con mucosa istologicamente normale (controlli). L’etnia era prevalentemente caucasica (90,3%), con una piccola quota di soggetti asiatici (3,2%) ed ebrei (6,5%).

L’attività clinica di malattia, valutata mediante UC symptom score (UCSS), mostrava una mediana pari a 1 (range 0–15), compatibile con una popolazione composta in larga parte da pazienti in remissione o con malattia lieve. I marcatori infiammatori sierici (calprotectina, VES ed hs-CRP) presentavano un’elevata proporzione di dati mancanti (circa il 32%); nei soggetti con dato disponibile, i valori risultavano complessivamente bassi, in linea con la distribuzione dell’attività di malattia.

I parametri ematologici e biochimici (emoglobina, leucociti totali, neutrofili, albumina) erano disponibili solo in una piccola sottopopolazione (circa 4–5% dei soggetti), con valori medi nei range attesi per pazienti ambulatoriali; per tale motivo questi parametri sono stati considerati descrittivi e non utilizzati nelle analisi successive.

La maggior parte dei pazienti non presentava problemi articolari (98,9%) né familiarità per IBD (93,5%). Circa un terzo dei soggetti era fumatore attuale o ex fumatore, sebbene anche per lo stato di fumo fosse presente una quota non trascurabile di dati mancanti (32,3%). Comorbidità extraintestinali di qualsiasi tipo erano riportate nel 59,1% dei casi.

Dal punto di vista endoscopico, il sito più frequentemente campionato era il sigma (62,4%), seguito da colon ascendente (17,2%), discendente (14,0%) e ileo terminale (6,5%). Al momento del prelievo, il 39,8% dei campioni proveniva da mucosa macroscopicamente infiammata, mentre il 60,2% da mucosa non infiammata. All’interno del gruppo UC, i pazienti erano ulteriormente classificati come malattia in remissione (39,8%), failure di terapia (19,4%) o nuova diagnosi (8,6%).

# Featuredata:

```{r}
feat_all <- featuredata |>
  mutate(
    # indici tecnici come numeri
    ID   = suppressWarnings(as.numeric(ID)),
    COL  = suppressWarnings(as.numeric(COL)),
    ROW  = suppressWarnings(as.numeric(ROW)),
    GENE = suppressWarnings(as.numeric(GENE)),

    # variabile categoriale vera
    CONTROL_TYPE = factor(CONTROL_TYPE),

    # indicatori presenza/assenza per tutte le annotazioni testuali
    HAS_NAME= factor(ifelse(is.na(NAME) | NAME== "", "No", "Yes")),
    HAS_SPOT_ID= factor(ifelse(is.na(SPOT_ID) | SPOT_ID== "", "No", "Yes")),
    HAS_REFSEQ= factor(ifelse(is.na(REFSEQ) | REFSEQ== "", "No", "Yes")),
    HAS_GB_ACC= factor(ifelse(is.na(GB_ACC) | GB_ACC== "", "No", "Yes")),
    HAS_GENE_SYMBOL= factor(ifelse(is.na(GENE_SYMBOL) | GENE_SYMBOL== "", "No", "Yes")),
    HAS_GENE_NAME= factor(ifelse(is.na(GENE_NAME) | GENE_NAME== "", "No", "Yes")),
    HAS_UNIGENE= factor(ifelse(is.na(UNIGENE_ID) | UNIGENE_ID== "", "No", "Yes")),
    HAS_ENSEMBL= factor(ifelse(is.na(ENSEMBL_ID) | ENSEMBL_ID== "", "No", "Yes")),
    HAS_TIGR= factor(ifelse(is.na(TIGR_ID) | TIGR_ID== "", "No", "Yes")),
    HAS_ACCESSION= factor(ifelse(is.na(ACCESSION_STRING) | ACCESSION_STRING == "", "No", "Yes")),
    HAS_CHR_LOC= factor(ifelse(is.na(CHROMOSOMAL_LOCATION) | CHROMOSOMAL_LOCATION== "", "No", "Yes")),
    HAS_CYTOBAND= factor(ifelse(is.na(CYTOBAND) | CYTOBAND== "", "No", "Yes")),
    HAS_DESCRIPTION= factor(ifelse(is.na(DESCRIPTION) | DESCRIPTION == "", "No", "Yes")),
    HAS_GO= factor(ifelse(is.na(GO_ID) | GO_ID== "", "No", "Yes")),
    HAS_SEQUENCE= factor(ifelse(is.na(SEQUENCE) | SEQUENCE== "", "No", "Yes"))
  )
```

```{r}
label(feat_all$ID) <- "Probe ID"
label(feat_all$COL) <- "Array column index"
label(feat_all$ROW) <- "Array row index"
label(feat_all$GENE) <- "Internal gene ID"
label(feat_all$CONTROL_TYPE) <- "Control type"
label(feat_all$HAS_NAME) <- "Has probe NAME"
label(feat_all$HAS_SPOT_ID) <- "Has SPOT_ID"
label(feat_all$HAS_REFSEQ) <- "Has RefSeq ID"
label(feat_all$HAS_GB_ACC) <- "Has GenBank accession"
label(feat_all$HAS_GENE_SYMBOL) <- "Has gene symbol"
label(feat_all$HAS_GENE_NAME) <- "Has gene name"
label(feat_all$HAS_UNIGENE) <- "Has UniGene ID"
label(feat_all$HAS_ENSEMBL) <- "Has Ensembl ID"
label(feat_all$HAS_TIGR) <- "Has TIGR ID"
label(feat_all$HAS_ACCESSION) <- "Has accession string"
label(feat_all$HAS_CHR_LOC) <- "Has chromosomal location"
label(feat_all$HAS_CYTOBAND) <- "Has cytoband"
label(feat_all$HAS_DESCRIPTION) <- "Has description"
label(feat_all$HAS_GO) <- "Has GO annotation"
label(feat_all$HAS_SEQUENCE) <- "Has probe sequence"

```

```{r}
table1(
  ~ CONTROL_TYPE +
    HAS_REFSEQ + HAS_GB_ACC +
    HAS_GENE_NAME + HAS_UNIGENE + HAS_ENSEMBL +
    HAS_TIGR + HAS_ACCESSION +
    HAS_CHR_LOC + HAS_CYTOBAND +
    HAS_DESCRIPTION + HAS_GO + HAS_SEQUENCE
  | HAS_GENE_SYMBOL,
  data = feat_all
)

```

```{r}
# 1) Quante righe ha finaldata (teoricamente ~8.2M)
nrow(finaldata)

# 2) Quanti patient diversi vede R
length(unique(finaldata$patient))

# 3) Quanti sample diversi ci sono:
#    spesso l'ID del campione è geo_accession, oppure source_name_ch1 o title
length(unique(finaldata$geo_accession))
length(unique(finaldata$source_name_ch1))
length(unique(finaldata$title))
```
