---
title: "03_augment"
format: html
---

# Augmenting

## Loading libraries

```{r}
#| message: false
#| warning: false

library("ggrepel")
library("dplyr")
library("tidyverse")
```

## Loading finaldata and featuredata

```{r}
#| message: false
#| warning: false

finaldata <- read_csv("../data/02_dat_clean.csv.gz")
featuredata <- read_csv("../data/02_dat_genbank.csv.gz")

colnames(finaldata)
colnames(featuredata)
```

#### Calculating the Age from date of birth

Birth date reformat - input a date in string format, with "/" as spacer. Date format should be in MM/DD/YY

```{r}
source(file = "99_proj_func.R")
```

Making the age variable from the date of birth and the submission date for the article, to estimate the age. at the time of sampling. We identified some birth dates that were written as MM/DD/1060, we belive it is a typo and what was meant was 1960. Hence we changed it to 1960.

```{r}
finaldata <- finaldata |> 
  mutate(birth_date = reformat_dates(birth_date)) |> 
  mutate(procedure_date = as.Date(procedure_date, "%m/%d/%y")) |> 
  mutate(age = round(as.numeric(difftime(procedure_date, birth_date, units = "days")) / 365.25, 0), .after=procedure_date) |> 
   mutate(age_group = case_when(
    20 <= age & age < 30 ~ "(20,30]",
    30 <= age & age < 40 ~ "(30,40]",
    40 <= age & age < 50 ~ "(40,50]",
    50 <= age & age < 60 ~ "(50,60]",
    60 <= age & age < 70 ~ "(60,70]",
    70 <= age & age < 80 ~ "(70,80]"
    ), .after=age)
```

#### Reformatting symptoms_onset_date & diagnosis_date & Calculating the time difference from symptoms_onset to diagnosis_date

Will reflect time between disease constetation and treatment. Shorter time from first symptom to treatment may slow the disease development.

```{r}
finaldata <- finaldata |> 
  mutate(symptoms_onset_date = as.Date(symptoms_onset_date, "%m/%d/%y")) |> 
  mutate(diagnosis_date = as.Date.character(diagnosis_date, "%m/%d/%y")) |>
  mutate(time_untreated = as.numeric(difftime(diagnosis_date, symptoms_onset_date, units = "days")), .after = diagnosis_date)
```

## Preparation for volcano plot

```{r}
final_clean <- finaldata |>
  filter(!is.na(gene_expr),
         !is.na(inflammation_status)) |>
  mutate(
    inflammation_status = factor(inflammation_status,
                                 levels = c("Uninflamed", "Inflamed")) # control first
  )
```

```{r}
de_results <- final_clean |>
  group_by(gene_id) |>
  # keep only genes with both groups present
  filter(n_distinct(inflammation_status) == 2) |>
  summarise(
    mean_inflamed   = mean(gene_expr[inflammation_status == "Inflamed"],   na.rm = TRUE),
    mean_uninflamed = mean(gene_expr[inflammation_status == "Uninflamed"], na.rm = TRUE),

    # already log2 â†’ fold change is just the difference
    log2FC = mean_inflamed - mean_uninflamed,

    p_value = tryCatch(
      t.test(gene_expr ~ inflammation_status)$p.value,
      error = function(e) NA_real_
    ),
    .groups = "drop"
  ) |>
  mutate(
    neg_log10_p = -log10(p_value),
    sig = p_value < 0.05   # or adjust later with p.adjust()
  )
```

## Preparation for Random Forest model

Reformatting expression dataframe with classifier (y_value) ready for a Random Forest Classifier model

```{r}
disease_geo <- finaldata |> 
  select(geo_accession, disease) |> 
  distinct(geo_accession, disease)

expr_df <- finaldata |> 
  select(geo_accession, gene_id, gene_expr) |> 
  filter(!is.na(gene_expr)) |> 
  pivot_wider(names_from = gene_id,
              values_from = gene_expr) |> 
  rename_with(~ paste0("Gene_", .), 
              .cols = -c(geo_accession)) |>
  mutate(across(starts_with("Gene_"), ~replace_na(., 0))) |>
  distinct(geo_accession, .keep_all = TRUE) |> 
  left_join(disease_geo, by = "geo_accession") |> 
  mutate(y_pred_UC = as.factor(case_when(disease == "Normal" ~ 0,
                               disease == "UC" ~ 1)),
         .keep = "unused")
```

## Exporting to data/

```{r}
write_csv(finaldata, file = "../data/03_dat_aug.csv.gz")
write_csv(featuredata, file = "../data/03_dat_genbank.csv.gz")
write_csv(de_results, file = "../data/03_de_results.csv.gz")
write_csv(expr_df, file = "../data/03_rf_expr_df.csv.gz")
```

## Cleaning environment

```{r}
rm(list = ls())
```
